---
title: "TBD"
author: "Keana Richards, Jeesung Ahn, Tonah Salas Ortiz"
date: " "
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
bibliography: ["library.bib"]

---

General notes on project:
- max of 15 pages 


```{r setup, include=FALSE}
options(scipen = 0, digits = 3, tibble.print_max = 50) 

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = F)

if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, here, glmnet, car, data.table, summarytools, corrplot, GGally, varhandle, gtsummary, pROC, stargazer, sjPlot, report,tm,SnowballC,wordcloud,RColorBrewer, imputeTS) 


plot_aes = theme_minimal() +
  theme(legend.position = "top",
        text = element_text(size = 15, family = "Futura Medium"),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        axis.ticks.y = element_blank())

# load data ---------------------------------------------------------------

food_name <- read.csv(here("cnf-fcen-csv", "FOOD_NAME.csv"))
food_group <- read.csv(here("cnf-fcen-csv", "FOOD_GROUP.csv"))
nutrient_amount <- read.csv(here("cnf-fcen-csv", "NUTRIENT_AMOUNT.csv"))
nutrient_name <- read.csv(here("cnf-fcen-csv", "NUTRIENT_NAME.csv"))

```


```{r}
## creating wide version of data for PCA

## merging datasets on identifiers

## start by identifying nutrients - merge nutrient amount & nutrient name 

nutrient_amount_merged <- left_join(nutrient_amount %>% select(NutrientID, NutrientValue, FoodID), nutrient_name %>% select(NutrientID, NutrientName, NutrientUnit), by = "NutrientID") 

## then merging add food group labels to food name dataset

food_name_merged <- left_join(food_name %>% select(FoodID, FoodGroupID, FoodDescription), food_group %>% select(FoodGroupID, FoodGroupName), by = "FoodGroupID") 

## creating wide version of nutrient_amount dataset to be merged with food_name

nutrient_amount_wide <- nutrient_amount_merged %>% select(-c(NutrientID, NutrientUnit)) %>%  pivot_wider(names_from = NutrientName, values_from = NutrientValue)

## merging wide nutrient_amount with food_name_merged

wide_data <- left_join(food_name_merged, nutrient_amount_wide, by = "FoodID") 

```


```{r}
## creating long version of data for logistic regression

long_data <- wide_data %>% pivot_longer(cols = PROTEIN:`OXALIC ACID`, names_to = "NutrientName", values_to = "NutrientValue")

```



# Executive Summary {#executive-summary} - Tonah


# Introduction {#introduction} - Tonah
- make sure to include citations - showing why this research matters (can you send me PDFs of the citations you include so I can include them in the final project doc)
	- create citations in the same way we did before in diabetes project 


# Methods {#methods}

## Data Summary /EDA {#eda} - Keana 

Our dataset originates from the most recent (updated in 2015) version of the [Canadian Nutrient File](https://www.canada.ca/en/health-canada/services/food-nutrition/healthy-eating/nutrient-data/canadian-nutrient-file-2015-download-files.html). The database contains average values for nutrients in foods available in Canada. These averages are based on the generic versions of a food, unless there is a brand specifically included in the database. This is a bilingual dataset with food names, descriptions, and background information that are in both French and English. One of the major goals in creating this version of the dataset was to update nutrient values for foods that are the largest contributors of sodium to the diet, since one of the major goals of manufacturers is to reduce sodium content of foods. 

To this end, the database assesses more than `r nrow(wide_data)` unique foods, ranging from foods such as `r wide_data %>% select(FoodDescription) %>% slice(1)` to `r wide_data %>% select(FoodDescription) %>% slice(174)`, and provides the average nutrient levels per 100 grams. 

Notably, some of the nutrients included are subcomponents of other nutrients. Or, like the two metrics for food energy (i.e., kcal and kJ), they are just different ways of measuring the same thing (i.e., one kcal = 4.184 kJ)

Also, it is worth noting that there are many values that are missing. For instance, only `r sum(is.na(wide_data %>% select(BIOTIN)))/nrow(wide_data)`% of the rows have values for biotin (see [Missing values in clean dataset section](#missing-vals-clean))

The original dataset was a relational dataset, with unique identifiers for the main variables of interest. Therefore, we had to merge on the unique identifiers (e.g., `FoodID`) across the relational datasets using the `left_join` function. Then, we 


The original dataset was cleaned for analyses in the following ways: 



(see [here](#clean-data-summary) for a full summary of the variables in the cleaned dataset). All of the subsequent summary statistics and analyses mentioned in the paper will be using the clean dataset. 




notes from here: chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf


description of file contents: 
From FOOD NAME.csv: 
FoodID (merging var)
FoodGroupID (merging var)
FoodDescription
From NUTRIENT NAME.csv:
NutrientID (merging var)
NutrientName
NutrientUnit (possibly as control??)
From NUTRIENT AMOUNT.csv:
NutrientValue
FoodID (merging var)
NutrientID (merging var)
From FOOD GROUP.csv
FoodGroupID (merging var)
FoodGroupName

Main file of interest is NUTRIENT AMOUNT.csv -- contains long version of dataset, where there are multiple rows for each food, along with a col for the nutrient identifier and the nutrient value associated with that identifier

Will have to combine the multiple datasets in one to have all info in one place 

"At  present  foods  are  grouped  under  23 different  group  headings  based  on  similar characteristics of the foods"

The foodnamesare only available  in this  version  in  one  lengthwhich does not include abbreviationsand can be up to 255 characters long

- All of the nutrient data is stored per 100g of the food (edible portion) - that is, all nutritional data is on the same scale 

- in cleaning - only selected variables of interest (e.g., we removed mean SE for the nutrient values, since there were many missing values)




## Analyses {#analyses} - Jeesung (both describing the analyses that were run - aka methods and running the analyses)

As mentioned before, there are several variables with multiple NA values. Therefore, to be able to run our target analyses, we needed to remove the NA values. We explored two different options for removing NA variables to see whether they would affect the results: mean imputation for all variables or first removing variables with more than 50% of NAs and then using mean imputation on the survived variables. 

We found that the options produced similar results across our different options for mean imputation, so we used the version of the dataset where we used mean imputation for all variables in all subsequent analyses. 

Since our goal is to identify the *best* algorithm for grouping foods that will help a person plan out their meals to best suit their needs, we compared different approaches to grouping the foods based on their nutrient profiles. That is, we wanted to maximize within-group similarity, while also minimizing between-group similarity, in nutrient profiles across different food groups. The first option we explored to achieve this goal was by applying k-means clustering to both versions of the dataset using the silhouette method to identify the optimal number of clusters. (briefly EXPLAIN LOGIC BEHIND THIS METHOD). 

  We will run spectrum clustering to see which foods are grouped together based on their nutrient profile. In doing so, we want to find out whether we can find clear-cut clusters of foods based on nutrition profile regardless of actual food group assignment. Our grouping results can be used to find the list of foods that contain the best combination of nutrients based on a persons dietary needs. This improves upon diets that try to rely on the actual food grouping, since our grouping result will be a better representation of the nutrient profile of a set of foods than the food group label, which may be determined arbitrarily.
  Since we have large dimensions of data (153 nutrient information for `r nrow(wide_data)` unique foods), we are going to run principal component analysis (PCA) to


Then, ran analysis on theoretically-driven set of nutrients (based on [WHO](https://www.medicalnewstoday.com/articles/326132)). 

## 1. Data Cleaning
```{r dealing with NAs, include=False}
######## data with mean imputation
data_mean_imp_temp<-wide_data %>% select(-c(FoodID,FoodGroupID,FoodDescription,FoodGroupName))
data_mean_imp<-imputeTS::na_mean(data_mean_imp_temp,option="mean")
# head(data_mean_imp)

######## data with variables that have more than 50% of NAs removed  + mean imputation of survived variables
NAinfo<-inspect.na(wide_data, summary = T)
halfNA<-NAinfo$column_name[NAinfo$ratio_of_NA>0.5]

# NA inspection per column: sapply(wide_data, function(x) sum(is.na(x)))
# NAinfo$ratio_of_NA[NAinfo$column_name=="FAT (TOTAL LIPIDS)"]
data_halfNArm<-wide_data %>% select(-c(halfNA,FoodID,FoodGroupID,FoodDescription,FoodGroupName))
data_halfNArm_mean_imp<-imputeTS::na_mean(data_halfNArm,option="mean")
# sum(is.na(data_halfNArm_mean_imp))
```

## 2.1 Option 1 to handle NAs: use mean imputed data
#### 2.1.1 Regular K-means Clustering 
###### Run k-means clustering
```{r regular kmeans}
# optimal number of clusters : according to silhouette method, 8 clusters is optimal  
set.seed(0)
factoextra::fviz_nbclust(data_mean_imp, kmeans, method = "silhouette")

##### run k-means clustering
data_mean_imp.kmeans <- data_mean_imp %>% kmeans(centers = 8)  # centers: number of cluster
print(c('Size of each cluster is', data_mean_imp.kmeans$size))

```
###### Plotting : two random variables 

```{r plot clustering}
##### randomly choose two variables and plot clustering results
data.frame(Carb = data_mean_imp$`CARBOHYDRATE, TOTAL (BY DIFFERENCE)`, 
          Kcal =data_mean_imp$`ENERGY (KILOCALORIES)`,
          group = as.factor(data_mean_imp.kmeans$cluster)) %>%
  ggplot(aes(x = Carb, y = Kcal, col = group)) +
  geom_point() +   ggtitle("Clustering over randomly chosen two variables")
# + ggrepel::geom_text_repel(aes(label = team))+

```
###### Plotting : wordcloud

```{r wordcloud}
###### data table with food name + clustering result
result_regular_kmeans<-wide_data %>% select (FoodDescription) %>%
        mutate(group = data_mean_imp.kmeans$cluster) %>% arrange(group)

###### Cluster 1 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==1]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

###### Cluster 2 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==2]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 3 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==3]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 4 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==4]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set1"))



###### Cluster 5
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==5]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 6
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==6]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set2"))



###### Cluster 7
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==7]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))



###### Cluster 8
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==8]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

```
###### Mean calories per cluster 

```{r calories}
###### average calory count per cluster
avg_calories=data_mean_imp %>% mutate(group = data_mean_imp.kmeans$cluster) %>% group_by(group) %>% summarize(mean.calories=mean(`ENERGY (KILOCALORIES)`),se.calories=sd(`ENERGY (KILOCALORIES)`) /sqrt(length(`ENERGY (KILOCALORIES)`)),std.calories=sd(`ENERGY (KILOCALORIES)`))

ggplot(avg_calories) +
    geom_bar(aes(x=group, y=mean.calories), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x=group, ymin=mean.calories-se.calories, ymax=mean.calories+se.calories), width=0.4, colour="orange", alpha=0.9, size=1.3)
```

###### Most important nutrients (PCA)
```{r most important nutrient}
# PCA of nutrients 
data_mean_imp_temp =data_mean_imp %>% mutate(group = data_mean_imp.kmeans$cluster) 
data_mean_imp.c1<-data_mean_imp_temp[data_mean_imp_temp$group==1,]
data_mean_imp.c2<-data_mean_imp_temp[data_mean_imp_temp$group==2,]
data_mean_imp.c3<-data_mean_imp_temp[data_mean_imp_temp$group==3,]
data_mean_imp.c4<-data_mean_imp_temp[data_mean_imp_temp$group==4,]
data_mean_imp.c5<-data_mean_imp_temp[data_mean_imp_temp$group==5,]
data_mean_imp.c6<-data_mean_imp_temp[data_mean_imp_temp$group==6,]
data_mean_imp.c7<-data_mean_imp_temp[data_mean_imp_temp$group==7,]
data_mean_imp.c8<-data_mean_imp_temp[data_mean_imp_temp$group==8,]

# Cluster 1 
data_mean_imp.pca <- prcomp(data_mean_imp.c1)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 1") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 2
data_mean_imp.pca <- prcomp(data_mean_imp.c2)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 2") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 3
data_mean_imp.pca <- prcomp(data_mean_imp.c3)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 3") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 4
data_mean_imp.pca <- prcomp(data_mean_imp.c4)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 4") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 5
data_mean_imp.pca <- prcomp(data_mean_imp.c5)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 5") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 6
data_mean_imp.pca <- prcomp(data_mean_imp.c6)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 6") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 7
data_mean_imp.pca <- prcomp(data_mean_imp.c7)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 7") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 8
data_mean_imp.pca <- prcomp(data_mean_imp.c8)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 8") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```

#### 2.1.2 Spectrum Clustering 
###### First, Run PCA
```{r PCA}
## RUN PCA of nutrient data
pca <- prcomp(data_mean_imp)

# names(pca)
pca.loading<-pca$rotation
# knitr::kable(pca.loading)
# summary(pca)$importance 

# How many PCs to use? --> 6~7 PCs seem to explain most variance according to elbow rule
plot(summary(pca)$importance[2, ],  # PVE
     ylab="PVE",
     xlab="Number of PC's",
     pch = 16, 
     main="Scree Plot of PVE for AFQT")
pve <- summary(pca)$importance[2, 1:10]
plot(pve, type="b", pch = 19, frame = FALSE)
# plot(summary(pca)$importance[3, ], pch=16,
 #    ylab="Cumulative PVE",
   #  xlab="Number of PC's",
  #   main="Scree Plot of Cumulative PVE for AFQT")
```
##### Most important nutrients used for spectrum clustering (PC1, PC2)
```{r}
## plot top 20 loadings
top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = pca$rotation[,1],
                  gene = rownames(pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = pca$rotation[,2],
                  gene = rownames(pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top loadings") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```
###### Run k-means clustering

```{r spectrum kmeans}
# optimal number of clusters : according to silhouette method, it's 8 (same as regular clustering). 
set.seed(0)
factoextra::fviz_nbclust(data_mean_imp, kmeans, method = "silhouette")

# kmeans 
data.mean.imp.spectrum.kmeans<- kmeans(x = pca$x[, 1:7], 8)
# color indicates the true cancer type
# shape indicates the cluster results 
```

##### Plotting : two PCs (Note: all exploratory plots)
```{r, include=F}
# Get row numbers for each cluster 
temp1<-data_mean_imp %>% mutate(cluster=data.mean.imp.spectrum.kmeans$cluster)
rownum1=as.numeric(rownames(temp1[temp1$cluster==1,]))
rownum2=as.numeric(rownames(temp1[temp1$cluster==2,]))
rownum3=as.numeric(rownames(temp1[temp1$cluster==3,]))
rownum4=as.numeric(rownames(temp1[temp1$cluster==4,]))
rownum5=as.numeric(rownames(temp1[temp1$cluster==5,]))
rownum6=as.numeric(rownames(temp1[temp1$cluster==6,]))
rownum7=as.numeric(rownames(temp1[temp1$cluster==7,]))
rownum8=as.numeric(rownames(temp1[temp1$cluster==8,]))
```

```{r, echo=F}
# PC1 and PC2, label= one representative food with highest PC score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])],rownum3[which.max(pca$x[rownum3,1])],rownum4[which.max(pca$x[rownum4,1])],rownum5[which.max(pca$x[rownum5,1])],rownum6[which.max(pca$x[rownum6,1])],rownum7[which.max(pca$x[rownum7,1])],rownum8[which.max(pca$x[rownum8,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp%>% mutate(max_pc_food=max_pc_food)

p <- data.table(x = pca$x[,1], 
                y = pca$x[,2],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC2") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,2], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC1 score")

#### PC3 and PC4, label= one representative food with highest PC3 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,3])],rownum2[which.max(pca$x[rownum2,3])],rownum3[which.max(pca$x[rownum3,3])],rownum4[which.max(pca$x[rownum4,3])],rownum5[which.max(pca$x[rownum5,3])],rownum6[which.max(pca$x[rownum6,3])],rownum7[which.max(pca$x[rownum7,3])],rownum8[which.max(pca$x[rownum8,3])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp%>% mutate(max_pc_food=max_pc_food)

p1 <- data.table(x = pca$x[,3], 
                y = pca$x[,4],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC3") + ylab("PC4") + ggrepel::geom_text_repel(aes(x = pca$x[,3],y = pca$x[,4], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC3 score")

#### PC1 and PC6, label= one representative food with highest PC1 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])],rownum3[which.max(pca$x[rownum3,1])],rownum4[which.max(pca$x[rownum4,1])],rownum5[which.max(pca$x[rownum5,1])],rownum6[which.max(pca$x[rownum6,1])],rownum7[which.max(pca$x[rownum7,1])],rownum8[which.max(pca$x[rownum8,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp%>% mutate(max_pc_food=max_pc_food)

p2 <- data.table(x = pca$x[,1], 
                y = pca$x[,6],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC6") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,6], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC1 score")

p
p1
p2

```

###### Plotting : wordcloud

```{r wordcloud}
###### data table with food name + clustering result
result_mean_imp_spectrum_kmeans<-wide_data %>% select (FoodDescription) %>%
        mutate(group = data.mean.imp.spectrum.kmeans$cluster) %>% arrange(group)

###### Cluster 1 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==1]))

# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

###### Cluster 2 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==2]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 3 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==3]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 4 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==4]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set1"))



###### Cluster 5
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==5]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 6
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==6]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set2"))



###### Cluster 7
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==7]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))



###### Cluster 8
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==8]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

```
###### Mean calories per cluster 

```{r calories}
###### average calory count per cluster
avg_calories=data_mean_imp %>% mutate(group=data.mean.imp.spectrum.kmeans$cluster) %>% group_by(group) %>% summarize(mean.calories=mean(`ENERGY (KILOCALORIES)`),se.calories=sd(`ENERGY (KILOCALORIES)`) /sqrt(length(`ENERGY (KILOCALORIES)`)),std.calories=sd(`ENERGY (KILOCALORIES)`))

ggplot(avg_calories) +
    geom_bar(aes(x=group, y=mean.calories), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x=group, ymin=mean.calories-se.calories, ymax=mean.calories+se.calories), width=0.4, colour="orange", alpha=0.9, size=1.3)
```

###### Most important nutrients (PCA)
```{r most important nutrient, echo=F}
# PCA of nutrients 
data_mean_imp_temp1 =data_mean_imp %>% mutate(group = data.mean.imp.spectrum.kmeans$cluster) 
data_mean_imp.c1<-data_mean_imp_temp1[data_mean_imp_temp1$group==1,]
data_mean_imp.c2<-data_mean_imp_temp1[data_mean_imp_temp1$group==2,]
data_mean_imp.c3<-data_mean_imp_temp1[data_mean_imp_temp1$group==3,]
data_mean_imp.c4<-data_mean_imp_temp1[data_mean_imp_temp1$group==4,]
data_mean_imp.c5<-data_mean_imp_temp1[data_mean_imp_temp1$group==5,]
data_mean_imp.c6<-data_mean_imp_temp1[data_mean_imp_temp1$group==6,]
data_mean_imp.c7<-data_mean_imp_temp1[data_mean_imp_temp1$group==7,]
data_mean_imp.c8<-data_mean_imp_temp1[data_mean_imp_temp1$group==8,]

# Cluster 1 
data_mean_imp.pca <- prcomp(data_mean_imp.c1)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 1") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 2
data_mean_imp.pca <- prcomp(data_mean_imp.c2)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 2") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 3
data_mean_imp.pca <- prcomp(data_mean_imp.c3)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 3") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 4
data_mean_imp.pca <- prcomp(data_mean_imp.c4)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 4") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 5
data_mean_imp.pca <- prcomp(data_mean_imp.c5)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 5") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 6
data_mean_imp.pca <- prcomp(data_mean_imp.c6)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 6") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 7
data_mean_imp.pca <- prcomp(data_mean_imp.c7)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 7") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 8
data_mean_imp.pca <- prcomp(data_mean_imp.c8)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp.pca$rotation[,1],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp.pca$rotation[,2],
                  gene = rownames(data_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 8") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```

## 2.2 Option 2 to handle NAs: remove variables with more than 50% of NAs + apply mean imputation
#### 2.1.1 Regular K-means Clustering 
###### Run k-means clustering
```{r regular kmeans}
# optimal number of clusters : according to silhouette method, 8 clusters is optimal  
set.seed(0)
factoextra::fviz_nbclust(data_halfNArm_mean_imp, kmeans, method = "silhouette")

##### run k-means clustering
data_halfNArm_mean_imp.kmeans <- data_halfNArm_mean_imp %>% kmeans(centers = 8)  # centers: number of cluster
print(c('Size of each cluster is', data_halfNArm_mean_imp.kmeans$size))
```
###### Plotting : two random variables 

```{r plot clustering}
##### randomly choose two variables and plot clustering results
data.frame(Carb = data_halfNArm_mean_imp$`CARBOHYDRATE, TOTAL (BY DIFFERENCE)`, 
          Kcal =data_halfNArm_mean_imp$`ENERGY (KILOCALORIES)`,
          group = as.factor(data_halfNArm_mean_imp.kmeans$cluster)) %>%
  ggplot(aes(x = Carb, y = Kcal, col = group)) +
  geom_point() +   ggtitle("Clustering over randomly chosen two variables")
# + ggrepel::geom_text_repel(aes(label = team))+

```
###### Plotting : wordcloud of each cluster

```{r wordcloud, echo=T}
###### data table with food name + clustering result
result_regular_kmeans<-wide_data %>% select (FoodDescription) %>%
        mutate(group = data_halfNArm_mean_imp.kmeans$cluster) %>% arrange(group)

###### Cluster 1 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==1]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

###### Cluster 2 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==2]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 3 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==3]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 4 
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==4]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set1"))



###### Cluster 5
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==5]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 6
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==6]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set2"))



###### Cluster 7
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==7]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))



###### Cluster 8
docs<-Corpus(VectorSource(result_regular_kmeans$FoodDescription[result_regular_kmeans$group==8]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

```
###### Mean calories per cluster 

```{r calories, echo=T}
###### average calory count per cluster
avg_calories=data_halfNArm_mean_imp %>% mutate(group = data_halfNArm_mean_imp.kmeans$cluster) %>% group_by(group) %>% summarize(mean.calories=mean(`ENERGY (KILOCALORIES)`),se.calories=sd(`ENERGY (KILOCALORIES)`) /sqrt(length(`ENERGY (KILOCALORIES)`)),std.calories=sd(`ENERGY (KILOCALORIES)`))

ggplot(avg_calories) +
    geom_bar(aes(x=group, y=mean.calories), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x=group, ymin=mean.calories-se.calories, ymax=mean.calories+se.calories), width=0.4, colour="orange", alpha=0.9, size=1.3)
```

###### Most important nutrients (PCA)
```{r most important nutrient}
# PCA of nutrients 
data_halfNArm_mean_imp_temp =data_halfNArm_mean_imp %>% mutate(group = data_halfNArm_mean_imp.kmeans$cluster) 
data_halfNArm_mean_imp.c1<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==1,]
data_halfNArm_mean_imp.c2<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==2,]
data_halfNArm_mean_imp.c3<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==3,]
data_halfNArm_mean_imp.c4<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==4,]
data_halfNArm_mean_imp.c5<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==5,]
data_halfNArm_mean_imp.c6<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==6,]
data_halfNArm_mean_imp.c7<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==7,]
data_halfNArm_mean_imp.c8<-data_halfNArm_mean_imp_temp[data_halfNArm_mean_imp_temp$group==8,]

# Cluster 1 
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c1)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 1") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 2
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c2)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 2") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 3
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c3)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 3") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 4
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c4)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 4") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 5
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c5)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 5") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 6
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c6)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 6") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 7
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c7)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 7") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 8
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c8)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 8") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```

#### 2.1.2 Spectrum Clustering 
###### First, Run PCA
```{r PCA}
## RUN PCA of nutrient data
pca <- prcomp(data_halfNArm_mean_imp)

# names(pca)
pca.loading<-pca$rotation
# knitr::kable(pca.loading)
# summary(pca)$importance 

# How many PCs to use? --> 6~7 PCs seem to explain most variance according to elbow rule
plot(summary(pca)$importance[2, ],  # PVE
     ylab="PVE",
     xlab="Number of PC's",
     pch = 16, 
     main="Scree Plot of PVE for AFQT")
pve <- summary(pca)$importance[2, 1:10]
plot(pve, type="b", pch = 19, frame = FALSE)
# plot(summary(pca)$importance[3, ], pch=16,
 #    ylab="Cumulative PVE",
   #  xlab="Number of PC's",
  #   main="Scree Plot of Cumulative PVE for AFQT")
```
##### Most important nutrients used for spectrum clustering (PC1, PC2)
```{r, echo=F}
## plot top 20 loadings
top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = pca$rotation[,1],
                  gene = rownames(pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = pca$rotation[,2],
                  gene = rownames(pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top loadings") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))

```
###### Run k-means clustering

```{r spectrum kmeans, echo=F}
# optimal number of clusters : according to silhouette method, it's 8 (same as regular clustering). 
set.seed(0)
factoextra::fviz_nbclust(data_halfNArm_mean_imp, kmeans, method = "silhouette")

# kmeans 
data.mean.imp.spectrum.kmeans<- kmeans(x = pca$x[, 1:7], 8)
# color indicates the true cancer type
# shape indicates the cluster results 
```

##### Plotting : two PCs (Note: all exploratory plots)
```{r, include=F}
# Get row numbers for each cluster 
temp1<-data_halfNArm_mean_imp %>% mutate(cluster=data.mean.imp.spectrum.kmeans$cluster)
rownum1=as.numeric(rownames(temp1[temp1$cluster==1,]))
rownum2=as.numeric(rownames(temp1[temp1$cluster==2,]))
rownum3=as.numeric(rownames(temp1[temp1$cluster==3,]))
rownum4=as.numeric(rownames(temp1[temp1$cluster==4,]))
rownum5=as.numeric(rownames(temp1[temp1$cluster==5,]))
rownum6=as.numeric(rownames(temp1[temp1$cluster==6,]))
rownum7=as.numeric(rownames(temp1[temp1$cluster==7,]))
rownum8=as.numeric(rownames(temp1[temp1$cluster==8,]))
```

```{r, echo=F}
# PC1 and PC2, label= one representative food with highest PC score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])],rownum3[which.max(pca$x[rownum3,1])],rownum4[which.max(pca$x[rownum4,1])],rownum5[which.max(pca$x[rownum5,1])],rownum6[which.max(pca$x[rownum6,1])],rownum7[which.max(pca$x[rownum7,1])],rownum8[which.max(pca$x[rownum8,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_halfNArm_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_halfNArm_mean_imp%>% mutate(max_pc_food=max_pc_food)

p <- data.table(x = pca$x[,1], 
                y = pca$x[,2],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC2") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,2], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC1 score")

#### PC3 and PC4, label= one representative food with highest PC3 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,3])],rownum2[which.max(pca$x[rownum2,3])],rownum3[which.max(pca$x[rownum3,3])],rownum4[which.max(pca$x[rownum4,3])],rownum5[which.max(pca$x[rownum5,3])],rownum6[which.max(pca$x[rownum6,3])],rownum7[which.max(pca$x[rownum7,3])],rownum8[which.max(pca$x[rownum8,3])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_halfNArm_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_halfNArm_mean_imp%>% mutate(max_pc_food=max_pc_food)

p1 <- data.table(x = pca$x[,3], 
                y = pca$x[,4],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC3") + ylab("PC4") + ggrepel::geom_text_repel(aes(x = pca$x[,3],y = pca$x[,4], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC3 score")

#### PC1 and PC6, label= one representative food with highest PC1 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])],rownum3[which.max(pca$x[rownum3,1])],rownum4[which.max(pca$x[rownum4,1])],rownum5[which.max(pca$x[rownum5,1])],rownum6[which.max(pca$x[rownum6,1])],rownum7[which.max(pca$x[rownum7,1])],rownum8[which.max(pca$x[rownum8,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_halfNArm_mean_imp)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_halfNArm_mean_imp%>% mutate(max_pc_food=max_pc_food)

p2 <- data.table(x = pca$x[,1], 
                y = pca$x[,6],
                col = as.factor(data.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(8)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC6") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,6], label=name, color = col, )) +ggtitle("8 Food Clusters Based on 7 PCs",subtitle = "label=food per cluster with highest PC1 score")

p
p1
p2

```

###### Plotting : wordcloud

```{r wordcloud, echo=F}
###### data table with food name + clustering result
result_mean_imp_spectrum_kmeans<-wide_data %>% select (FoodDescription) %>%
        mutate(group = data.mean.imp.spectrum.kmeans$cluster) %>% arrange(group)

###### Cluster 1 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==1]))

# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

###### Cluster 2 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==2]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 3 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==3]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 4 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==4]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set1"))



###### Cluster 5
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==5]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


###### Cluster 6
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==6]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Set2"))



###### Cluster 7
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==7]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))



###### Cluster 8
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==8]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

```
###### Mean calories per cluster 

```{r calories}
###### average calory count per cluster
avg_calories=data_halfNArm_mean_imp %>% mutate(group=data.mean.imp.spectrum.kmeans$cluster) %>% group_by(group) %>% summarize(mean.calories=mean(`ENERGY (KILOCALORIES)`),se.calories=sd(`ENERGY (KILOCALORIES)`) /sqrt(length(`ENERGY (KILOCALORIES)`)),std.calories=sd(`ENERGY (KILOCALORIES)`))

ggplot(avg_calories) +
    geom_bar(aes(x=group, y=mean.calories), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x=group, ymin=mean.calories-se.calories, ymax=mean.calories+se.calories), width=0.4, colour="orange", alpha=0.9, size=1.3)
```

###### Most important nutrients (PCA)
```{r most important nutrient, echo=F}
# PCA of nutrients 
data_halfNArm_mean_imp_temp1 =data_halfNArm_mean_imp %>% mutate(group = data.mean.imp.spectrum.kmeans$cluster) 
data_halfNArm_mean_imp.c1<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==1,]
data_halfNArm_mean_imp.c2<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==2,]
data_halfNArm_mean_imp.c3<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==3,]
data_halfNArm_mean_imp.c4<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==4,]
data_halfNArm_mean_imp.c5<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==5,]
data_halfNArm_mean_imp.c6<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==6,]
data_halfNArm_mean_imp.c7<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==7,]
data_halfNArm_mean_imp.c8<-data_halfNArm_mean_imp_temp1[data_halfNArm_mean_imp_temp1$group==8,]

# Cluster 1 
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c1)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 1") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 2
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c2)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 2") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 3
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c3)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 3") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))



# Cluster 4
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c4)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 4") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 5
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c5)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 5") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 6
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c6)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 6") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 7
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c7)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 7") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 8
data_halfNArm_mean_imp.pca <- prcomp(data_halfNArm_mean_imp.c8)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,1],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_halfNArm_mean_imp.pca$rotation[,2],
                  gene = rownames(data_halfNArm_mean_imp.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 8") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```

# 3. Theoretically Driven Nutrients & Spectrum Clustering 
- Choose the most crucial nutrients (https://www.medicalnewstoday.com/articles/326132) and run clustering based on them
- Vitamin, minerals (magnesium,calcium, phosphorus,sulfur,socium,potassium,chloride,iron,selenum,zinc,magnaese,chromium,copper,iodine,fluoride,molybdenum), water, portein, carbohydrates, fats, energy(kcal)

```{r}
# select crucial nutrients from mean imputed data
data_mean_imp_crucial=data_mean_imp %>% select(c(starts_with("VIT"),MAGNESIUM,CALCIUM,PHOSPHORUS,POTASSIUM,`CHOLINE, TOTAL`,IRON,SELENIUM,ZINC,MANGANESE,COPPER,MOISTURE,PROTEIN,`CARBOHYDRATE, TOTAL (BY DIFFERENCE)`,`FAT (TOTAL LIPIDS)`,`FATTY ACIDS, TRANS, TOTAL`,`FATTY ACIDS, SATURATED, TOTAL`,`FATTY ACIDS, MONOUNSATURATED, TOTAL`,`FATTY ACIDS, POLYUNSATURATED, TOTAL`,`FATTY ACIDS, TOTAL TRANS-MONOENOIC`,`FATTY ACIDS, TOTAL TRANS-POLYENOIC`,`ENERGY (KILOCALORIES)`))

oldnames=names(data_mean_imp_crucial%>%select(-c(contains("VIT"),contains("PROTEIN"),contains("CARBO"),contains("FAT"),contains("ENERGY"))))

newnames=c("Minerals_MAGNESIUM","Minerals_CALCIUM","Minerals_PHOSPHORUS","Minerals_POTASSIUM", "Minerals_CHOLINE, TOTAL" ,"Minerals_IRON","Minerals_SELENIUM","Minerals_ZINC","Minerals_MANGANESE","COPPER","Water_MOISTURE")

data_mean_imp_crucial=data_mean_imp_crucial %>% rename_at(vars(oldnames), ~ newnames)
  
```

###### First, Run PCA
```{r PCA}
## RUN PCA of nutrient data
pca <- prcomp(data_mean_imp_crucial)

# names(pca)
pca.loading<-pca$rotation
# knitr::kable(pca.loading)
# summary(pca)$importance 

# How many PCs to use? --> 6 PCs seem to explain most variance according to elbow rule
plot(summary(pca)$importance[2, ],  # PVE
     ylab="PVE",
     xlab="Number of PC's",
     pch = 16, 
     main="Scree Plot of PVE for AFQT")
pve <- summary(pca)$importance[2, 1:10]
plot(pve, type="b", pch = 19, frame = FALSE)
# plot(summary(pca)$importance[3, ], pch=16,
 #    ylab="Cumulative PVE",
   #  xlab="Number of PC's",
  #   main="Scree Plot of Cumulative PVE for AFQT")
```
##### Most important nutrients used for spectrum clustering (PC1, PC2)
```{r}
## plot top 20 loadings
top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = pca$rotation[,1],
                  gene = rownames(pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = pca$rotation[,2],
                  gene = rownames(pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top loadings") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```
###### Run k-means clustering

```{r spectrum kmeans}
# optimal number of clusters : according to silhouette method, it's 2
set.seed(0)
factoextra::fviz_nbclust(data_mean_imp_crucial, kmeans, method = "silhouette")

# kmeans 
data.crucial.mean.imp.spectrum.kmeans<- kmeans(x = pca$x[, 1:6], 2)
# color indicates the true cancer type
# shape indicates the cluster results 
```

##### Plotting : two PCs (Note: all exploratory plots)
```{r, include=F}
# Get row numbers for each cluster 
temp1<-data_mean_imp_crucial %>% mutate(cluster=data.crucial.mean.imp.spectrum.kmeans$cluster)
rownum1=as.numeric(rownames(temp1[temp1$cluster==1,]))
rownum2=as.numeric(rownames(temp1[temp1$cluster==2,]))
```

```{r, echo=F}
# PC1 and PC2, label= one representative food with highest PC score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp_crucial)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp_crucial%>% mutate(max_pc_food=max_pc_food)

p <- data.table(x = pca$x[,1], 
                y = pca$x[,2],
                col = as.factor(data.crucial.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(2)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC2") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,2], label=name, color = col, )) +ggtitle("2 Food Clusters Based on 6 PCs",subtitle = "label=food per cluster with highest PC1 score")

#### PC3 and PC4, label= one representative food with highest PC3 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,3])],rownum2[which.max(pca$x[rownum2,3])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp_crucial)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp_crucial%>% mutate(max_pc_food=max_pc_food)

p1 <- data.table(x = pca$x[,3], 
                y = pca$x[,4],
                col = as.factor(data.crucial.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(2)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC3") + ylab("PC4") + ggrepel::geom_text_repel(aes(x = pca$x[,3],y = pca$x[,4], label=name, color = col, )) +ggtitle("2 Food Clusters Based on 6 PCs",subtitle = "label=food per cluster with highest PC3 score")

#### PC1 and PC6, label= one representative food with highest PC1 score
max_pcscore_rownum=c(rownum1[which.max(pca$x[rownum1,1])],rownum2[which.max(pca$x[rownum2,1])])

max_pc_score_df<-as.factor(wide_data$FoodDescription[max_pcscore_rownum])
max_pc_food <- rep(NA, dim(data_mean_imp_crucial)[1])
for (i in 1:length(max_pcscore_rownum)){max_pc_food[max_pcscore_rownum[i]]=as.character(max_pc_score_df[i])}

temp2<-data_mean_imp_crucial%>% mutate(max_pc_food=max_pc_food)

p2 <- data.table(x = pca$x[,1], 
                y = pca$x[,6],
                col = as.factor(data.crucial.mean.imp.spectrum.kmeans$cluster),name=temp2$max_pc_food) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(2)) +
  theme_bw() + labs(color = "Food Clusters") +xlab("PC1") + ylab("PC6") + ggrepel::geom_text_repel(aes(x = pca$x[,1],y = pca$x[,6], label=name, color = col, )) +ggtitle("2 Food Clusters Based on 6 PCs",subtitle = "label=food per cluster with highest PC1 score")

p
p1
p2

```

###### Plotting : wordcloud

```{r wordcloud}
###### data table with food name + clustering result
result_mean_imp_spectrum_kmeans<-wide_data %>% select (FoodDescription) %>%
        mutate(group = data.crucial.mean.imp.spectrum.kmeans$cluster) %>% arrange(group)

###### Cluster 1 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==1]))

# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))

###### Cluster 2 
docs<-Corpus(VectorSource(result_mean_imp_spectrum_kmeans$FoodDescription[result_mean_imp_spectrum_kmeans$group==2]))
# inspect(docs)
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
dtm <- TermDocumentMatrix(docs) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
df <- data.frame(word = names(words),freq=words)
set.seed(1234) # for reproducibility 
wordcloud(words = df$word, freq = df$freq, min.freq = 1, max.words=200, random.order=FALSE, rot.per=0.35, colors=brewer.pal(8, "Dark2"))


```
###### Mean calories per cluster 

```{r calories}
###### average calory count per cluster
avg_calories=data_mean_imp_crucial %>% mutate(group=data.crucial.mean.imp.spectrum.kmeans$cluster) %>% group_by(group) %>% summarize(mean.calories=mean(`ENERGY (KILOCALORIES)`),se.calories=sd(`ENERGY (KILOCALORIES)`) /sqrt(length(`ENERGY (KILOCALORIES)`)),std.calories=sd(`ENERGY (KILOCALORIES)`))

ggplot(avg_calories) +
    geom_bar(aes(x=group, y=mean.calories), stat="identity", fill="skyblue", alpha=0.7) +
    geom_errorbar( aes(x=group, ymin=mean.calories-se.calories, ymax=mean.calories+se.calories), width=0.4, colour="orange", alpha=0.9, size=1.3)
```

###### Most important nutrients (PCA)
```{r most important nutrient, echo=F}
# PCA of nutrients 
data_mean_imp_crucial_temp1 =data_mean_imp_crucial %>% mutate(group = data.crucial.mean.imp.spectrum.kmeans$cluster) 
data_mean_imp_crucial.c1<-data_mean_imp_crucial_temp1[data_mean_imp_crucial_temp1$group==1,]
data_mean_imp_crucial.c2<-data_mean_imp_crucial_temp1[data_mean_imp_crucial_temp1$group==2,]

# Cluster 1 
data_mean_imp_crucial.pca <- prcomp(data_mean_imp_crucial.c1)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp_crucial.pca$rotation[,1],
                  gene = rownames(data_mean_imp_crucial.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp_crucial.pca$rotation[,2],
                  gene = rownames(data_mean_imp_crucial.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 1") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


# Cluster 2
data_mean_imp_crucial.pca <- prcomp(data_mean_imp_crucial.c2)

top_k <- 20
## get pc1 and pc2
pc1 <- data.frame(loading = data_mean_imp_crucial.pca$rotation[,1],
                  gene = rownames(data_mean_imp_crucial.pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = data_mean_imp_crucial.pca$rotation[,2],
                  gene = rownames(data_mean_imp_crucial.pca$rotation),
                  pc = "PC2")
# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)
rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top Nutrients of Cluster 2") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))


```

# Results - Keana 

Will only describe one mean imputation result (probably the one that best maximizes within similarity and minimizes between similarity across the different approaches. 

First approach: K means clustering on all available nutrients
Describe:
- characteristics of cluster - size of cluster, within & between group SS 
- plot of the "clustering over two randomly chosen variables" 
- words clouds
		- interesting that cluster 1 and cluster 8 both have dehydrated as the common word 
- mean kcal per cluster 
		- cluster 6 (seems to be associated with high-sugar foods) --  has highest kcal level 
- most important nutrients based on PCA 

Second approach: spectrum clustering on all available nutrients
Describe:
- results from PCA (scree plot), elbow rule 
- characteristics of cluster - size of cluster, within & between group SS 
- plot of the "8 food clusters bsaed on 7 PCs" 
- words clouds
		- results are bsaically the samee here  
- mean kcal per cluster 
- most important nutrients based on PCA 

Third approach: spectrum clustering on theoretically-driven nutrients 
Describe:
- plot of the "clustering over two randomly chosen variables" 
- words clouds
- mean kcal per cluster 
- most important nutrients based on PCA 


Once we've decided on the best method - Make recommendation for a person who has certain dietary needs 



- possibly use this package: https://github.com/easystats/parameters
- use tab_model or stargazer for showing regressions (see previous write ups for examples)






# Conclusion {#conclusion} - Keana 

chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The CNF is particularly suited for assessment of diets, recipe development, menu planning when  ingredients  or  menu  items  are  not  specific  and  for  population  nutrition  surveillance activities, where nutrient intake distributions areused to conduct risk assessments such as modeling  for  fortification  proposals.    It  is  also  useful  in  the  initial  stages  of  product development to ensure that nutritional targets can be met. 

# Limitations {#limitations} - Keana 

chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The exact nutrient  composition  of  a  specific  apple  or  cookie isnot  found  on  the  CNF.    These averages,  except  where  indicated  otherwise,  take  into  account  sources  of  a  given  food across Canada.  Local foods may have a different profile than the national average.
- Most  users  are  lookingfor  an  average  or  mean  value  for  a  generic  representation  of  the foods  as described.    These generic  values  have  been  derived  from  combining  brands  of similar  products,  for  example  all  major  brands  of  ketchup;  various  varieties  of  oranges  or similar  beef  cuts  from  various  producers.  
- This dataset is only relevant to products available in Canada - so the results cannot be generalized to products from other countries. Therefore future research should explore whether these findings replicate among products in other countries.
- the nutrient values are all standardized, not representative of how much a person may actually consume in a package - would need to convert to nutrient values for the actual portions people eat to be interpretable 

# Appendix {#appendix} - Keana 


## Full summary of clean dataset {#clean-data-summary}

```{r, results = 'asis', cache = T}
wide_data %>% select(-c(FoodID, FoodGroupID, FoodDescription)) %>% dfSummary(.,  plain.ascii = FALSE, style = 'grid', graph.magnif = 0.75, 
          valid.col = FALSE, tmp.img.dir = "/tmp")

```

## Missing values in clean dataset {#missing-vals-clean}

```{r}
inspect.na(wide_data, summary = F)
```

## Citations for packages used 

```{r, results = 'asis'}

report(sessionInfo())
```

- possibly use this to write functions 



# References


\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

