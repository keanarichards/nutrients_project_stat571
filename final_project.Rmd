---
title: "Recommendations for an intelligent diet"
author: "Keana Richards, Jeesung Ahn, Tonah Salas Ortiz"
date: ' '
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
bibliography: library.bib
---

```{r setup, include=FALSE}
options(scipen = 0, digits = 3, tibble.print_max = 50) 

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = F)

if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, here, glmnet, car, data.table, summarytools, corrplot, GGally, varhandle, gtsummary, pROC, stargazer, sjPlot, report,tm,SnowballC,wordcloud,RColorBrewer, imputeTS) 


plot_aes = theme_minimal() +
  theme(legend.position = "top",
        text = element_text(size = 15, family = "Futura Medium"),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        axis.ticks.y = element_blank())

# run code ---------------------------------------------------------------

source(here("source.R"))
```

# Executive Summary {#executive-summary}

Many countries around the world provide nationwide dietary guidelines to the public and require nutrition labels on food products to help people make informed choices about foods and drinks they consume. Every individual, however, has different nutrition needs and preferences according to their age, sex, ethnicity, height, weight, and physical activity level, among many other factors. Therefore, people may benefit from more personalized dietary recommendations. Our goal is to provide the basis for an algorithm that recommends foods a person should consume based on their nutrition needs. To this end, we compared different approaches to grouping foods based on their nutrient profiles (i.e., spectrum clustering vs. k-means clustering). As expected, spectrum clustering provides better clustering, so we explore the clusters created through spectrum clustering further. Finally, we demonstrate how others can use our data-driven food groupings to meet their dietary needs. 

# Introduction {#introduction} 

## Importance of nutrition in affecting everyday life 
- make sure to include citations - showing why this research matters (can you send me PDFs of the citations you include so I can include them in the final project doc)
	- create citations in the same way we did before in diabetes project 


## Problem with current food groupings 

Although foods are grouped together in different categories, the means by which these food groupings are created is unclear, so food items in a certain group may not necessarily have the same nutrient profile. A new interpretation of food groupings can change the way diets are currently made - helping people make more “intelligent” diet decisions. More specifically, the results of this study can be used to find the list of foods that have the best combination of nutrients based on a person's dietary needs.

# Study goals

In the current project, we aim to provide the basis for an algorithm that recommends foods a person should consume based on their nutrition needs. In more concrete terms, we wanted to identify clusters of foods that have the highest intra-group similarity and lowest inter-group similarity based on their nutrient profile. 

# Methods {#methods}

## Exploratory data analysis {#eda} 

Our dataset originates from the most recent version of the [Canadian Nutrient File](https://www.canada.ca/en/health-canada/services/food-nutrition/healthy-eating/nutrient-data/canadian-nutrient-file-2015-download-files.html) (updated in 2015), provided on the Canadian government site. The database contains average values for nutrients in foods available in Canada, with much of the data coming from the USDA National Nutrient Database for Standard Reference. These averages are based on the generic versions of a food, unless there is a brand specifically included in the database. This is a bilingual dataset with food names, descriptions, and background information that are in both French and English. This version of the database was created to update nutrient values for foods that are the largest contributors of sodium to the diet, since one of the major goals of manufacturers is to reduce sodium content of foods. To this end, the database assesses more than `r nrow(wide_data)` unique foods, ranging from foods such as `r wide_data %>% select(FoodDescription) %>% slice(1)` to `r wide_data %>% select(FoodDescription) %>% slice(174)`, and provides the average nutrient levels per 100 grams. 

The original data came as a set of separate datasets that had columns with identifiers (e.g., `FoodID`) to link them, so we then merged the datasets based on the unique identifiers and selected the main variables of interest: the food labels and the nutrient profile associated with a given food label. With this subsetted version of the data, we ran exploratory data analyses.  

First, we noticed that some of the nutrients included are subcomponents of other nutrients. For instance, there is a total sugars column that is a sum of several other columns in the data. In other cases, there are columns that are essentially different ways of measuring the same nutrient. So for example, there are two metrics for food energy (i.e., kilocalories and kilojoules), where one kilocalorie is equal to 4.184 kilojoules. We decided to leave these variables as they were, since we expected the methods used in our analyses to be able to essentially ignore these redundancies. 

Also, it is worth noting that there are many values that are missing. For instance, only `r sum(is.na(wide_data %>% select(BIOTIN)))/nrow(wide_data)`% of the rows have values for biotin (see [Missing values in clean dataset section](#missing-vals-clean)). To be able to run our target analyses (which requires a dataset with only nonmissing data), we needed to remove the missing values. We explored two different options for removing missing variables to see whether they would affect the results: mean imputation (i.e., inserted the mean of a column into any rows in that column that are missing) for all variables or first removing variables with more than 50% of missing values and then using mean imputation on the survived variables. We found that the options produced similar results across our different options for mean imputation, so we used the version of the dataset where we used mean imputation for all variables in all subsequent analyses. See [the appendix](#clean-data-summary) for a full summary of the variables in the cleaned dataset after using mean imputation for all variables. 

## Main analyses {#analyses}

Since our goal is to identify the *best* algorithm for grouping foods that will help a person plan out their meals to best suit their needs, we compared different approaches to grouping the foods based on their nutrient profiles. That is, we compared different methods to make sure foods are as similar as possible in terms of their nutrient profile (that is, we wanted to maximize in-group similarity), while also making sure foods assigned to different groups have very different nutrient profiles (in other words, minimize out-group similarity). The slides, code, and database associated with this project is publicly available [here](tinyurl.com/4x43u439). 

The first option we explored to achieve this goal was using k-means clustering on the dataset. K-means clustering is a commonly used unsupervised machine learning algorithm to divide a dataset into pre-specified set of groups (known as clusters in this context). The algorithm assigned foods to clusters based on which assignments will keep the distance between the nutrient profile of each food assigned to a cluster and the mean nutrient profile for a given cluster as low as possible. In other words, it tries to assign foods to clusters that will achieve the highest possible intra-group similarity for the cluster number that we specified. To identify the optimal number of clusters, we used the silhouette method - which essentially compares the quality of clusters produced across a different range of cluster sizes. 

The second approach we explored was using spectrum clustering. Spectrum clustering adds another step right before the k-means clustering approach. Instead of using the raw data to create clusters, spectrum clustering minimizes the number of variables that we cluster on by including a principal components analysis (also known as PCA) right before the clustering analysis. PCA may be especially advantageous when there are a large number of variables you want to cluster on, because it tries to linearly combine the old variables into new ones (aka PC scores) in a way that maximizes the variance. By maximizing variance during PCA, we can reduce the dimensions of the data without losing much information from the original data. Once we had the PC scores, we used the silhouette method like before to identify the optimal number of clusters before running k-means clustering.  

These were the two main clustering approaches that we compared. Since spectrum clustering combines the power of noise reduction through PCA with clustering analyses, we expected beforehand that it would be a better approach for grouping our data. 

# Results

## Comparing k-means clustering to spectrum clustering 
### First approach: K means clustering on all available nutrients

The silhouette method recommended we use 8 clusters, so we ran k-means clustering using `kmeans()` with centers set to 8. Once created, we explored some of the characteristics of the clusters. First, there is a wide range in the number of foods assigned to each cluster, with the largest cluster consisting of `r max(data_mean_imp.kmeans$size)` and the smallest cluster consisting of `r min(data_mean_imp.kmeans$size)`, and a median cluster size of `r median(data_mean_imp.kmeans$size)`. Ideally, the between-cluster sum of squares should be a large proportion of the total sum of squares (the total distance of all observations from the global center) (https://stats.stackexchange.com/questions/82776/what-does-total-ss-and-between-ss-mean-in-k-means-clustering), which would suggest that there is high separation between groups. (data_mean_imp.kmeans$betweenss/data_mean_imp.kmeans$totss)*100

https://www.datanovia.com/en/lessons/cluster-validation-statistics-must-know-methods/

Describe:
- characteristics of cluster - size of cluster, within & between group SS 
- plot of the "clustering over two randomly chosen variables" 

This plot here shows what the clusters looked like using k-means clustering across two randomly chosen variables: carbs and calories, along with the mean values of each cluster for those variables. As you can see, there isn’t very clear separation between clusters. With the 8 clusters used for k-means clustering, the average of the total within-cluster sum of squares across clusters was pretty big: 2.18 to the ninth (2184371146)



```{r}
## install & load clValid package 

# install.packages("clValid")
# library(clValid)

data_mean_imp_standardized<- data_mean_imp_standardized[, -c(146, 152)]
data_mean_imp.kmeans.standardized <- clValid(data_mean_imp_standardized, nClust = 2:10,
clMethods = "kmeans", validation = "internal", maxitems = 6000)

data_mean_imp.kmeans.version2 <- clValid(data_mean_imp, nClust = 2:10,
clMethods = "kmeans", validation = "internal", maxitems = 6000)

## mean silhouette for reg k means clusterse
ss <- cluster::silhouette(data_mean_imp.kmeans$cluster, dist(data_mean_imp))
mean(ss[, 3])

## mean silhouette for spectrum clustering
ss1 <- cluster::silhouette(data.mean.imp.spectrum.kmeans$cluster, dist(pca$x[,1:10]))
mean(ss1[, 3])



```

### Second approach: spectrum clustering on all available nutrients
Describe:
- results from PCA (scree plot), elbow rule 
- characteristics of cluster - size of cluster, within & between group SS 
- plot of the "8 food clusters bsaed on 7 PCs" 

This plot here shows what the clusters looked like using spectrum clustering across the first two PCs, along with labels for the food in each cluster with the highest absolute PC1 score. The separation between clusters here is more obvious, which is supported by the lower average of the total within-cluster sum of squares across clusters for the spectrum clustering, at 22017

### Spectrum clustering provides better clusters 

Since the goal of clustering is to maximize intra-group similarity, we identify which of the results has the smallest average total within-cluster sum of squares across clusters to determine which option might be better. Thus, our results support our hypothesis that spectrum clustering would provide much better groups of foods, maximizing the similarity of nutrient profiles of foods within any given cluster. 

## Exploring "intelligent" clusters

We plotted different words clouds of the most commonly used words within each cluster. So for instance, here you can see that the most commonly used word in cluster 2 by far was “raw”, along with “meat” “lean” and “beef”. this cloud tends to have more meats, so it will likely have a higher protein content compared to other clusters. 


We also explored which groups tend to have the highest calorie content - and by far the highest calorie groups were clusters 3 and 4. So if someone was trying to reduce their overall calorie intake, it may be a good idea to avoid these food groups. 

- words clouds
		- results are bsaically the samee here  
- mean kcal per cluster 
- most important nutrients based on PCA 

## Spectrum clustering on theoretically-driven nutrients 
Describe:
- plot of the "clustering over two randomly chosen variables" 
- words clouds
- mean kcal per cluster 
- most important nutrients based on PCA 

## Case studies 

After determining the best clustering approach based on food nutrient profile, we provide two case studies to serve as examples of how this tool can be used to make recommendations for a person who has specific dietary needs. 

### Case study 1. Following a diet to gain muscle 

Arnold is an aspiring professional bodybuilder that is interested in gaining muscle as quickly as possible. Since he knows the importance of nutrition in affecting the muscle-building process, he plans to change his diet to achieve this goal and has decided to follow the guidance he found at the links [here](https://www.coachmag.co.uk/nutrition/healthy-eating/1263/12-best-nutrients-and-vitamins-building-muscle-and-burning-fat) and [here](https://www.muscleandfitness.com/nutrition/gain-mass/10-nutrition-rules-follow-if-you-want-build-muscle/). Since Arnold is currently 180 pounds and a person that wants to gain muscle is recommended to consume 1.5 grams of protein per pound of bodyweight, his target daily intake of protein is 270 grams per day. It is also recommended that people consume between 2-3 grams of carbohydrates per pound to gain muscle. Therefore, Arnold aims to consume between 360 and 540 grams of total carbohydrates per day. Fat is another important macronutrient that will affect Arnold's muscle-building process. Since the articles he found suggest between 20 and 30 percent of his calories should come from fat, he aims to consume X grams of fat per day. Finally, it is recommended that he consume at least 3600 kilocalories per day to gain muscle. There are also several other nutrients that he would like to consume at above 2 SDs above the mean based on their muscle-building properties including: calcium, biotin, iron, vitamin C, selenium, Omega 3, Vitamin D, vitamin B12, copper, magnesium, riboflavin, and zinc. 

To simulate Arnold, we created a copy of the dataset from our main analyses and compare the macronutrient breakdown of Arnold to the daily nutrient recommendations based on his age and gender, and use that as point of comparison. eg compared to most people, arnold's diet will be relatively high in protein, low in carbs, and average in fat. So use multiplier, this ensures everything is on the same scale.

To determine a point of comparison for Arnold's nutrient intake, we used the [DRI Calculator for Healthcare Professionals from the National Argicultural Library](https://www.nal.usda.gov/fnic/dri-calculator/). This tool calculates daily nutrient recommendations based on the Dietary Reference Intakes (DRIs) established by the Health and Medicine Division of the National Academies of Sciences, Engineering and Medicine, representing the most current scientific knowledge on nutrient needs. We inserted gender (Male), age  (20), height (5 feet 10 inches), weight (180 pounds), and activity level (sedentary) for someone who matches Arnold on all characteristics *but* activity level, since Arnold will be above the mean on activity level compared to the typical person. Therefore, the nutrient recommendations provided by this tool provide a representation of someone who matches Arnold on all characteristics, but does not aspire to be a pro bodybuilder like he does (and hence has a lower activity level). 


multipliers for arnold compared to average person:
2734 kcal/day = 1.32
total carbs: 	308 - 444 grams (average is 376) = 1.2
protein: 65 g = 4.15
sat fat = 270 times (because they are told to keep it as low as possible so rec for avg person might be 1g)
total fat = 10.8 

code for ID multipliers for arnold

```{r}
# calories

3600/2734

# carbs

450/mean(c(444,308))

# protein

270/65

# sat fat

mean(c(3600*(.05), 3600*(.1)))

# overall fat
# arnold is recommended to have 900 g of fat/day (avg of 20-30%)
3600*.25

900/mean(c(61, 106))
```

To provide our recommendation, we tried to identify the cluster that most closely matched Arnold’s nutrient needs (that is, his goal nutrient profile had the smallest euclidean distance from the food group). Based on our analyses, Arnold would best achieve his goals by eating foods in cluster 5. So we recommend Arnold target foods like, turkey, brussel sprouts, and pork, all of which are found in cluster 5. 

Although we chose to focus on one specific example of the practical uses of this work, there are a number of other contexts that are relevant: sports nutrition, helping athletes perform better by recommending the foods that best satisfy their needs
it can also be used by the general public for muscle gain and fat loss
finally it can help patients of chronic illness identify groups of foods that help improve their medical condition

- possibly use this package: https://github.com/easystats/parameters
- use tab_model or stargazer for showing regressions (see previous write ups for examples)

# Conclusion {#conclusion} 

Our results support our a priori hypothesis that spectrum clustering would provide much better groups of foods, maximizing the similarity of nutrient profiles of foods within any given cluster. 


chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The CNF is particularly suited for assessment of diets, recipe development, menu planning when  ingredients  or  menu  items  are  not  specific  and  for  population  nutrition  surveillance activities, where nutrient intake distributions areused to conduct risk assessments such as modeling  for  fortification  proposals.    It  is  also  useful  in  the  initial  stages  of  product development to ensure that nutritional targets can be met. 

# Limitations {#limitations} 

chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The exact nutrient  composition  of  a  specific  apple  or  cookie isnot  found  on  the  CNF.    These averages,  except  where  indicated  otherwise,  take  into  account  sources  of  a  given  food across Canada.  Local foods may have a different profile than the national average.
- Most  users  are  lookingfor  an  average  or  mean  value  for  a  generic  representation  of  the foods  as described.    These generic  values  have  been  derived  from  combining  brands  of similar  products,  for  example  all  major  brands  of  ketchup;  various  varieties  of  oranges  or similar  beef  cuts  from  various  producers.  
- This dataset is only relevant to products available in Canada - so the results cannot be generalized to products from other countries. Therefore future research should explore whether these findings replicate among products in other countries.
- the nutrient values are all standardized, not representative of how much a person may actually consume in a package - would need to convert to nutrient values for the actual portions people eat to be interpretable 

# Appendix {#appendix} 


## Full summary of clean dataset {#clean-data-summary}

```{r, results = 'asis', cache = T}
data_mean_imp %>% select(-c(FoodID, FoodGroupID, FoodDescription)) %>% dfSummary(.,  plain.ascii = FALSE, style = 'grid', graph.magnif = 0.75, 
          valid.col = FALSE, tmp.img.dir = "/tmp")

```

## Missing values in clean dataset {#missing-vals-clean}

```{r}
inspect.na(wide_data, summary = F)
```

## Citations for packages used 

```{r, results = 'asis'}

report(sessionInfo())
```

- possibly use this to write functions 


# References


\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

