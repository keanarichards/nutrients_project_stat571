---
title: "TBD"
author: "Keana Richards, Jeesung Ahn, Tonah Salas Ortiz"
date: " "
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
bibliography: ["library.bib"]

---

General notes on project:
- max of 15 pages 


```{r setup, include=FALSE}
options(scipen = 0, digits = 3, tibble.print_max = 50) 

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = F)

if(!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, here, glmnet, car, data.table, summarytools, corrplot, GGally, varhandle, gtsummary, pROC, stargazer, sjPlot, report) 



plot_aes = theme_minimal() +
  theme(legend.position = "top",
        text = element_text(size = 15, family = "Futura Medium"),
        axis.text = element_text(color = "black"),
        axis.line = element_line(colour = "black"),
        axis.ticks.y = element_blank())

# load data ---------------------------------------------------------------

food_name <- read.csv(here("cnf-fcen-csv", "FOOD_NAME.csv"))
food_group <- read.csv(here("cnf-fcen-csv", "FOOD_GROUP.csv"))
nutrient_amount <- read.csv(here("cnf-fcen-csv", "NUTRIENT_AMOUNT.csv"))
nutrient_name <- read.csv(here("cnf-fcen-csv", "NUTRIENT_NAME.csv"))

```


```{r}
## creating wide version of data for PCA

## merging datasets on identifiers

## start by identifying nutrients - merge nutrient amount & nutrient name 

nutrient_amount_merged <- left_join(nutrient_amount %>% select(NutrientID, NutrientValue, FoodID), nutrient_name %>% select(NutrientID, NutrientName, NutrientUnit), by = "NutrientID") 

## then merging add food group labels to food name dataset

food_name_merged <- left_join(food_name %>% select(FoodID, FoodGroupID, FoodDescription), food_group %>% select(FoodGroupID, FoodGroupName), by = "FoodGroupID") 

## creating wide version of nutrient_amount dataset to be merged with food_name

nutrient_amount_wide <- nutrient_amount_merged %>% select(-c(NutrientID, NutrientUnit)) %>%  pivot_wider(names_from = NutrientName, values_from = NutrientValue)

## merging wide nutrient_amount with food_name_merged

wide_data <- left_join(food_name_merged, nutrient_amount_wide, by = "FoodID") 

```


```{r}
## creating long version of data for logistic regression

long_data <- wide_data %>% pivot_longer(cols = PROTEIN:`OXALIC ACID`, names_to = "NutrientName", values_to = "NutrientValue")

```



# Executive Summary {#executive-summary} - Tonah


# Introduction {#introduction} - Tonah
- make sure to include citations - showing why this research matters (can you send me PDFs of the citations you include so I can include them in the final project doc)
	- create citations in the same way we did before in diabetes project 


# Methods {#methods}

## Data Summary /EDA {#eda} - Keana 

Our dataset originates from the most recent (updated in 2015) version of the [Canadian Nutrient File](https://www.canada.ca/en/health-canada/services/food-nutrition/healthy-eating/nutrient-data/canadian-nutrient-file-2015-download-files.html). The database contains average values for nutrients in foods available in Canada. These averages are based on the generic versions of a food, unless there is a brand specifically included in the database. This is a bilingual dataset with food names, descriptions, and background information that are in both French and English. One of the major goals in creating this version of the dataset was to update nutrient values for foods that are the largest contributors of sodium to the diet, since one of the major goals of manufacturers is to reduce sodium content of foods. 

To this end, the database assesses more than `r nrow(wide_data)` unique foods, ranging from foods such as `r wide_data %>% select(FoodDescription) %>% slice(1)` to `r wide_data %>% select(FoodDescription) %>% slice(174)`, and provides the average nutrient levels per 100 grams. 

Notably, some of the nutrients included are subcomponents of other nutrients. Or, like the two metrics for food energy (i.e., kcal and kJ), they are just different ways of measuring the same thing (i.e., one kcal = 4.184 kJ)

Also, it is worth noting that there are many values that are missing. For instance, only `r sum(is.na(wide_data %>% select(BIOTIN)))/nrow(wide_data)`% of the rows have values for biotin (see [Missing values in clean dataset section](#missing-vals-clean))

The original dataset was a relational dataset, with unique identifiers for the main variables of interest. Therefore, we had to merge on the unique identifiers (e.g., `FoodID`) across the relational datasets using the `left_join` function. Then, we 


The original dataset was cleaned for analyses in the following ways: 



(see [here](#clean-data-summary) for a full summary of the variables in the cleaned dataset). All of the subsequent summary statistics and analyses mentioned in the paper will be using the clean dataset. 




notes from here: chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf


description of file contents: 
From FOOD NAME.csv: 
FoodID (merging var)
FoodGroupID (merging var)
FoodDescription
From NUTRIENT NAME.csv:
NutrientID (merging var)
NutrientName
NutrientUnit (possibly as control??)
From NUTRIENT AMOUNT.csv:
NutrientValue
FoodID (merging var)
NutrientID (merging var)
From FOOD GROUP.csv
FoodGroupID (merging var)
FoodGroupName

Main file of interest is NUTRIENT AMOUNT.csv -- contains long version of dataset, where there are multiple rows for each food, along with a col for the nutrient identifier and the nutrient value associated with that identifier

Will have to combine the multiple datasets in one to have all info in one place 

"At  present  foods  are  grouped  under  23 different  group  headings  based  on  similar characteristics of the foods"

The foodnamesare only available  in this  version  in  one  lengthwhich does not include abbreviationsand can be up to 255 characters long

- All of the nutrient data is stored per 100g of the food (edible portion) - that is, all nutritional data is on the same scale 

- in cleaning - only selected variables of interest (e.g., we removed mean SE for the nutrient values, since there were many missing values)




## Analyses {#analyses} - Jeesung (both describing the analyses that were run - aka methods and running the analyses)

  We will run spectrum clustering to see which foods are grouped together based on their nutrient profile. In doing so, we want to find out whether we can find clear-cut clusters of foods based on nutrition profile regardless of actual food group assignment. Our grouping results can be used to find the list of foods that contain the best combination of nutrients based on a personâ€™s dietary needs. This improves upon diets that try to rely on the actual food grouping, since our grouping result will be a better representation of the nutrient profile of a set of foods than the food group label, which may be determined arbitrarily.
  Since we have large dimensions of data (153 nutrient information for `r nrow(wide_data)` unique foods), we are going to run principal component analysis (PCA) to

<< To Be Decided Together with Team>>
1. How to deal with NAs? : want to run PCA and find ideal number of PCs that will be used for spectrum clustering. can't run prcomp with NAs.(if use na.omit -- no single food will survive -- recode all NAs to 0 for prelim analyses)

2. prcomp : scale and center each column? 

3. two Energy variables -- only use one? or remove these two? i like the idea of predicting average calories of each cluster that we will assign-- any recommended methods to do this? just report average calories of each cluster? 
- FYI, according to PCA, Energy is top loading nutrient of PC1 

4. Prelim results : spectrum clustering using 7 PCs and 5 clusters (when plotted, results don't look pretty)


```{r PCA}
# recode NAs to 0 to run PCA 
nutrient_only<-wide_data %>% select(-c(FoodID,FoodGroupID,FoodDescription,FoodGroupName)) 
nutrient_only[is.na(nutrient_only)] <- 0
head(nutrient_only)

## RUN PCA of nutrient data
pca <- prcomp(nutrient_only,scale=T,center=T)

# names(pca)
pca.loading<-pca$rotation
# knitr::kable(pca.loading)
# summary(pca)$importance 

# How many PCs to use? --> 7~8 PCs seem to explain most variance according to elbow rule
plot(summary(pca)$importance[2, ],  # PVE
     ylab="PVE",
     xlab="Number of PC's",
     pch = 16, 
     main="Scree Plot of PVE for AFQT")

pve <- summary(pca)$importance[2, 1:10]
plot(pve, type="b", pch = 19, frame = FALSE)

# plot(summary(pca)$importance[3, ], pch=16,
 #    ylab="Cumulative PVE",
   #  xlab="Number of PC's",
  #   main="Scree Plot of Cumulative PVE for AFQT")

```

```{r}
## plot top 20 loadings
top_k <- 20

## get pc1 and pc2
pc1 <- data.frame(loading = pca$rotation[,1],
                  gene = rownames(pca$rotation),
                  pc = "PC1")
pc2 <- data.frame(loading = pca$rotation[,2],
                  gene = rownames(pca$rotation),
                  pc = "PC2")

# get top_k of pc1 and pc2
pc1_top <- pc1 %>% arrange(-loading) %>% slice(1:top_k)
pc2_top <- pc2 %>% arrange(-loading) %>% slice(1:top_k)

rbind(pc1_top, pc2_top) %>%
  ggplot(aes(x = reorder(gene, -loading), y = loading)) +
  geom_point() +
  ggtitle("Top loadings") +
  xlab("Nutrient") +
  facet_wrap(~pc, nrow = 1, scales = "free_x") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = -45, hjust = 0, vjust = 1))
```

```{r spectrum kmeans}
# optimal number of clusters : according to silhouette method, it's 5. 
set.seed(0)
factoextra::fviz_nbclust(nutrient_only, kmeans, method = "silhouette")

# kmeans 
kmean<- kmeans(x = pca$x[, 1:7], 5)

# color indicates the true cancer type
# shape indicates the cluster results 
p <- data.table(x = pca$x[,1], 
                y = pca$x[,2],
                cl = as.factor(wide_data$FoodGroupName),
                col = as.factor(kmean$cluster)) %>%
  ggplot() + 
  geom_point(aes(x = x, y = y, col = col))+
  scale_color_manual(values = scales::hue_pal()(5)) +
  theme_bw() +
  labs(color = "Food Clusters") +
  xlab("PC1") +
  ylab("PC2")


p
```

```{r, include=False}
head(wide_data,20)
dim(wide_data)
unique(wide_data$FoodDescription)
names(wide_data)
head(nutrient_amount_merged)
names(nutrient_amount_wide)
```

Predict calories?


- use tab_model or stargazer for showing regressions (see previous write ups for examples)

- use silhouette method from lecture on clustering to decide on a number of clusters

- just write the code to create the models & figures & Keana will incorporate the results into the results/appendix section - no need to write out the stat output from models - just a summary of what they generally show & logic will be helpful 

- last time there was writing between the code - which made the formatting look a little weird (ie weird spacing between paragaphs where the code was). this time, let's have all of the code at the end of a section so the formatting doesn't get messed up 

- possibly use this package for assessing model fit (if included): https://github.com/easystats/performance
What are the words in food description that predict the cluster they might be in? 



# Results - Keana 

- possibly use this package: https://github.com/easystats/parameters

# Conclusion {#conclusion} - Keana 

chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The CNF is particularly suited for assessment of diets, recipe development, menu planning when  ingredients  or  menu  items  are  not  specific  and  for  population  nutrition  surveillance activities, where nutrient intake distributions areused to conduct risk assessments such as modeling  for  fortification  proposals.    It  is  also  useful  in  the  initial  stages  of  product development to ensure that nutritional targets can be met. 

# Limitations {#limitations} - Keana 

chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/file:///C:/Users/keana/OneDrive%20-%20PennO365/Comp_transfer2018/Penn/fourth_yr/nutrients_project_stat571/cnf-fcen-csv/CNF%202015%20users_guide%20EN.pdf
- The exact nutrient  composition  of  a  specific  apple  or  cookie isnot  found  on  the  CNF.    These averages,  except  where  indicated  otherwise,  take  into  account  sources  of  a  given  food across Canada.  Local foods may have a different profile than the national average.
- Most  users  are  lookingfor  an  average  or  mean  value  for  a  generic  representation  of  the foods  as described.    These generic  values  have  been  derived  from  combining  brands  of similar  products,  for  example  all  major  brands  of  ketchup;  various  varieties  of  oranges  or similar  beef  cuts  from  various  producers.  
- This dataset is only relevant to products available in Canada - so the results cannot be generalized to products from other countries. Therefore future research should explore whether these findings replicate among products in other countries.
- the nutrient values are all standardized, not representative of how much a person may actually consume in a package - would need to convert to nutrient values for the actual portions people eat to be interpretable 

# Appendix {#appendix} - Keana 


## Full summary of clean dataset {#clean-data-summary}

```{r, results = 'asis', cache = T}
wide_data %>% select(-c(FoodID, FoodGroupID, FoodDescription)) %>% dfSummary(.,  plain.ascii = FALSE, style = 'grid', graph.magnif = 0.75, 
          valid.col = FALSE, tmp.img.dir = "/tmp")

```

## Missing values in clean dataset {#missing-vals-clean}

```{r}
inspect.na(wide_data, summary = F)
```

## Citations for packages used 

```{r, results = 'asis'}

report(sessionInfo())
```

- possibly use this to write functions 



# References


\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

